var JSON;JSON||(JSON={});
(function(){function k(a){return a<10?"0"+a:a}function o(a){p.lastIndex=0;return p.test(a)?'"'+a.replace(p,function(a){var c=r[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function l(a,i){var c,d,h,m,g=e,f,b=i[a];b&&typeof b==="object"&&typeof b.toJSON==="function"&&(b=b.toJSON(a));typeof j==="function"&&(b=j.call(i,a,b));switch(typeof b){case "string":return o(b);case "number":return isFinite(b)?String(b):"null";case "boolean":case "null":return String(b);case "object":if(!b)return"null";
e+=n;f=[];if(Object.prototype.toString.apply(b)==="[object Array]"){m=b.length;for(c=0;c<m;c+=1)f[c]=l(c,b)||"null";h=f.length===0?"[]":e?"[\n"+e+f.join(",\n"+e)+"\n"+g+"]":"["+f.join(",")+"]";e=g;return h}if(j&&typeof j==="object"){m=j.length;for(c=0;c<m;c+=1)d=j[c],typeof d==="string"&&(h=l(d,b))&&f.push(o(d)+(e?": ":":")+h)}else for(d in b)Object.hasOwnProperty.call(b,d)&&(h=l(d,b))&&f.push(o(d)+(e?": ":":")+h);h=f.length===0?"{}":e?"{\n"+e+f.join(",\n"+e)+"\n"+g+"}":"{"+f.join(",")+"}";e=g;return h}}
if(typeof Date.prototype.toJSON!=="function")Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+k(this.getUTCMonth()+1)+"-"+k(this.getUTCDate())+"T"+k(this.getUTCHours())+":"+k(this.getUTCMinutes())+":"+k(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()};var q=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,p=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e,n,r={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},j;if(typeof JSON.stringify!=="function")JSON.stringify=function(a,i,c){var d;n=e="";if(typeof c==="number")for(d=0;d<c;d+=1)n+=" ";else typeof c==="string"&&(n=c);if((j=i)&&typeof i!=="function"&&(typeof i!=="object"||typeof i.length!=="number"))throw Error("JSON.stringify");return l("",{"":a})};if(typeof JSON.parse!=="function")JSON.parse=function(a,e){function c(a,d){var g,f,b=a[d];if(b&&typeof b==="object")for(g in b)Object.hasOwnProperty.call(b,
g)&&(f=c(b,g),f!==void 0?b[g]=f:delete b[g]);return e.call(a,d,b)}var d,a=String(a);q.lastIndex=0;q.test(a)&&(a=a.replace(q,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return d=eval("("+a+")"),typeof e==="function"?c({"":d},""):d;throw new SyntaxError("JSON.parse");}})();
(function(){for(var b,a=function(){},e="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,table,time,timeEnd,timeStamp,trace,warn".split(","),f=e.length,c=window.console=window.console||{};f--;)b=e[f],c[b]||(c[b]=a)})();
typeof jQuery!=="undefined"&&function(b){var a={xdomain:"*",ie:navigator.userAgent.toLowerCase().indexOf("msie")>-1},e={init:function(){return this.each(function(){var a=b(this);window.postMessage?window.addEventListener?window.addEventListener("message",function(d){f.messageHandler(a,d)},!1):window.attachEvent&&window.attachEvent("onmessage",function(d){f.messageHandler(a,d)},a):setInterval(function(){var d=window.location.hash.match(/^#h(\d+)(s?)$/);d&&(f.setHeight(a,d[1]),d[2]==="s"&&scroll(0,
0))},150)})}},f={messageHandler:function(c,d){var b,g;a.xdomain!=="*"&&(b=d.origin.match(RegExp(a.xdomain+"$")));if(a.xdomain==="*"||b.length===1)if(b=d.data+"",(g=b.match(/^(\d+)(s?)$/))&&g.length===3){b=parseInt(g[1],10);if(!isNaN(b))try{f.setHeight(c,b)}catch(e){}g[2]==="s"&&scroll(0,0)}},setHeight:function(a,d){a.css("height",d+"px")},getDocHeight:function(){var a=document;return Math.min(Math.max(a.body.scrollHeight,a.documentElement.scrollHeight),Math.max(a.body.offsetHeight,a.documentElement.offsetHeight),
Math.max(a.body.clientHeight,a.documentElement.clientHeight))}};b.fn.responsiveIframe=function(c){if(e[c])return e[c].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof c==="object"||!c)return b.extend(a,arguments[0]),e.init.apply(this);else b.error("Method "+c+" does not exist on jQuery.responsiveIframe")}}(jQuery);
(function(){function b(){return new e}var a,e=function(){a=this};e.prototype.allowResponsiveEmbedding=function(){window.addEventListener?(window.addEventListener("load",a.messageParent,!1),window.addEventListener("resize",a.messageParent,!1)):window.attachEvent&&(window.attachEvent("onload",a.messageParent),window.attachEvent("onresize",a.messageParent))};e.prototype.messageParent=function(){var a=document.body.offsetHeight;console.log(a);top.postMessage&&top.postMessage(a,"*")};"undefined"===typeof exports?
window.responsiveIframe=b:(void 0).exports.responsiveIframe=b})();
(typeof window.localStorage=="undefined"||typeof window.sessionStorage=="undefined")&&function(){var b=function(a){function b(a,c,g){var e;g?(e=new Date,e.setTime(e.getTime()+g*864E5),g="; expires="+e.toGMTString()):g="";document.cookie=a+"="+c+g+"; path=/"}function f(d){d=JSON.stringify(d);a=="session"?window.name=d:b("localStorage",d,365)}var c=function(){var d;if(a=="session")d=window.name;else a:{d=document.cookie.split(";");var b,c;for(b=0;b<d.length;b++){for(c=d[b];c.charAt(0)==" ";)c=c.substring(1,
c.length);if(c.indexOf("localStorage=")==0){d=c.substring(13,c.length);break a}}d=null}return d?JSON.parse(d):{}}();return{length:0,clear:function(){c={};this.length=0;a=="session"?window.name="":b("localStorage","",365)},getItem:function(a){return c[a]===void 0?null:c[a]},key:function(a){var b=0,e;for(e in c)if(b==a)return e;else b++;return null},removeItem:function(a){delete c[a];this.length--;f(c)},setItem:function(a,b){c[a]=b+"";this.length++;f(c)}}};if(typeof window.localStorage=="undefined")window.localStorage=
new b("local");if(typeof window.sessionStorage=="undefined")window.sessionStorage=new b("session")}();
var CSSMatrix=function(){function b(a){this.transformObj=a;return this.init()}b.prototype.init=function(){if(this.transformObj&&this.transformObj!=="none"&&this.transformObj.indexOf("matrix")>-1)if("WebKitCSSMatrix"in window)return new WebKitCSSMatrix(this.transformObj);else if("MSCSSMatrix"in window)return new MSCSSMatrix(this.transformObj);else{var a=this.transformObj.indexOf("(");if(a>-1&&(a=(this.transformObj.substr(a+1)||"").match(/(?:\-|\b)[\d\-\.e]+\b/gi)||[],a.length==16))return{a:a[0],b:a[4],
c:a[1],d:a[5],e:a[2],f:a[6],m11:a[0],m12:a[1],m13:a[2],m14:a[3],m21:a[4],m22:a[5],m23:a[6],m24:a[7],m31:a[8],m32:a[9],m33:a[10],m34:a[11],m41:a[12],m42:a[13],m43:a[14],m44:a[15],matrix:a}}return null};return b}(),Helper={tmplReplaceReg:/<%\s*?=\s*?(\w+)\s*?%>/i,tmplGReplaceReg:/<%\s*?=\s*?(\w+)\s*?%>/gi,template:function(b,a){var e=b.match(Helper.tmplGReplaceReg);if(e&&e.length>0){var f,c;for(c in a)for(var d=0;d<e.length;++d)if((f=e[d].match(Helper.tmplReplaceReg))&&f.length>1&&f[1]==c){b=b.replace(RegExp("<%\\s*?=\\s*?"+
f[1]+"\\s*?%>","gi"),a[c]);break}}return b}},SnoffeStats={logStat:function(b,a){if(gamestat)b.logStr=a,gamestat.log(b),Snoffe.debug&&console.log("SnoffeStats.logStat",a)}};
(function(b){function s(a){var d=a.data;a.isDefaultPrevented()||(a.preventDefault(),b(this).ajaxSubmit(d))}function w(a){var d=a.target,h=b(d);if(!h.is("[type=submit],[type=image]")){d=h.closest("[type=submit]");if(d.length===0)return;d=d[0]}var c=this;c.clk=d;if(d.type=="image")a.offsetX!==void 0?(c.clk_x=a.offsetX,c.clk_y=a.offsetY):typeof b.fn.offset=="function"?(h=h.offset(),c.clk_x=a.pageX-h.left,c.clk_y=a.pageY-h.top):(c.clk_x=a.pageX-d.offsetLeft,c.clk_y=a.pageY-d.offsetTop);setTimeout(function(){c.clk=
c.clk_x=c.clk_y=null},100)}function p(){if(b.fn.ajaxSubmit.debug){var a="[jquery.form] "+Array.prototype.join.call(arguments,"");window.console&&window.console.log?window.console.log(a):window.opera&&window.opera.postError&&window.opera.postError(a)}}var y,z;y=b("<input type='file'/>").get(0).files!==void 0;z=window.FormData!==void 0;b.fn.ajaxSubmit=function(a){function d(a){var a=b.param(a).split("&"),c=a.length,d={},f,h;for(f=0;f<c;f++)a[f]=a[f].replace(/\+/g," "),h=a[f].split("="),d[decodeURIComponent(h[0])]=
decodeURIComponent(h[1]);return d}function h(c){for(var f=new FormData,h=0;h<c.length;h++)f.append(c[h].name,c[h].value);if(a.extraData){var c=d(a.extraData),g;for(g in c)c.hasOwnProperty(g)&&f.append(g,c[g])}a.data=null;g=b.extend(!0,{},b.ajaxSettings,a,{contentType:!1,processData:!1,cache:!1,type:k||"POST"});if(a.uploadProgress)g.xhr=function(){var b=jQuery.ajaxSettings.xhr();if(b.upload)b.upload.onprogress=function(b){var e=0,c=b.loaded||b.position,f=b.total;b.lengthComputable&&(e=Math.ceil(c/
f*100));a.uploadProgress(b,c,f,e)};return b};g.data=null;var j=g.beforeSend;g.beforeSend=function(a,b){b.data=f;j&&j.call(this,a,b)};return b.ajax(g)}function c(c){function f(){function a(){try{var b=(o.contentWindow?o.contentWindow.document:o.contentDocument?o.contentDocument:o.document).readyState;p("state = "+b);b&&b.toLowerCase()=="uninitialized"&&setTimeout(a,50)}catch(c){p("Server abort: ",c," (",c.name,")"),h(w),s&&clearTimeout(s),s=void 0}}var c=m.attr("target"),i=m.attr("action");d.setAttribute("target",
n);k||d.setAttribute("method","POST");i!=e.url&&d.setAttribute("action",e.url);!e.skipEncodingOverride&&(!k||/post/i.test(k))&&m.attr({encoding:"multipart/form-data",enctype:"multipart/form-data"});e.timeout&&(s=setTimeout(function(){u=!0;h(x)},e.timeout));var g=[];try{if(e.extraData)for(var j in e.extraData)e.extraData.hasOwnProperty(j)&&(b.isPlainObject(e.extraData[j])&&e.extraData[j].hasOwnProperty("name")&&e.extraData[j].hasOwnProperty("value")?g.push(b('<input type="hidden" name="'+e.extraData[j].name+
'">').val(e.extraData[j].value).appendTo(d)[0]):g.push(b('<input type="hidden" name="'+j+'">').val(e.extraData[j]).appendTo(d)[0]));e.iframeTarget||(v.appendTo("body"),o.attachEvent?o.attachEvent("onload",h):o.addEventListener("load",h,!1));setTimeout(a,15);d.submit()}finally{d.setAttribute("action",i),c?d.setAttribute("target",c):m.removeAttr("target"),b(g).remove()}}function h(a){if(!i.aborted&&!B){try{q=o.contentWindow?o.contentWindow.document:o.contentDocument?o.contentDocument:o.document}catch(c){p("cannot access response document: ",
c),a=w}if(a===x&&i)i.abort("timeout"),t.reject(i,"timeout");else if(a==w&&i)i.abort("server abort"),t.reject(i,"error","server abort");else if(q&&q.location.href!=e.iframeSrc||u){o.detachEvent?o.detachEvent("onload",h):o.removeEventListener("load",h,!1);var a="success",d;try{if(u)throw"timeout";var f=e.dataType=="xml"||q.XMLDocument||b.isXMLDoc(q);p("isXml="+f);if(!f&&window.opera&&(q.body===null||!q.body.innerHTML)&&--z){p("requeing onLoad callback, DOM not available");setTimeout(h,250);return}var g=
q.body?q.body:q.documentElement;i.responseText=g?g.innerHTML:null;i.responseXML=q.XMLDocument?q.XMLDocument:q;if(f)e.dataType="xml";i.getResponseHeader=function(a){return{"content-type":e.dataType}[a]};if(g)i.status=Number(g.getAttribute("status"))||i.status,i.statusText=g.getAttribute("statusText")||i.statusText;var k=(e.dataType||"").toLowerCase(),m=/(json|script|text)/.test(k);if(m||e.textarea){var l=q.getElementsByTagName("textarea")[0];if(l)i.responseText=l.value,i.status=Number(l.getAttribute("status"))||
i.status,i.statusText=l.getAttribute("statusText")||i.statusText;else if(m){var n=q.getElementsByTagName("pre")[0],r=q.getElementsByTagName("body")[0];if(n)i.responseText=n.textContent?n.textContent:n.innerText;else if(r)i.responseText=r.textContent?r.textContent:r.innerText}}else if(k=="xml"&&!i.responseXML&&i.responseText)i.responseXML=D(i.responseText);try{y=E(i,k,e)}catch(C){a="parsererror",i.error=d=C||a}}catch(A){p("error caught: ",A),a="error",i.error=d=A||a}i.aborted&&(p("upload aborted"),
a=null);i.status&&(a=i.status>=200&&i.status<300||i.status===304?"success":"error");if(a==="success")e.success&&e.success.call(e.context,y,"success",i),t.resolve(i.responseText,"success",i),j&&b.event.trigger("ajaxSuccess",[i,e]);else if(a){if(d===void 0)d=i.statusText;e.error&&e.error.call(e.context,i,a,d);t.reject(i,"error",d);j&&b.event.trigger("ajaxError",[i,e,d])}j&&b.event.trigger("ajaxComplete",[i,e]);j&&!--b.active&&b.event.trigger("ajaxStop");e.complete&&e.complete.call(e.context,i,a);B=
!0;e.timeout&&clearTimeout(s);setTimeout(function(){e.iframeTarget||v.remove();i.responseXML=null},100)}}}var d=m[0],g,e,j,n,v,o,i,r,u,s;r=!!b.fn.prop;var t=b.Deferred();if(b("[name=submit],[id=submit]",d).length)return alert('Error: Form elements must not have name or id of "submit".'),t.reject(),t;if(c)for(g=0;g<l.length;g++)c=b(l[g]),r?c.prop("disabled",!1):c.removeAttr("disabled");e=b.extend(!0,{},b.ajaxSettings,a);e.context=e.context||e;n="jqFormIO"+(new Date).getTime();e.iframeTarget?(v=b(e.iframeTarget),
(c=v.attr("name"))?n=c:v.attr("name",n)):(v=b('<iframe name="'+n+'" src="'+e.iframeSrc+'" />'),v.css({position:"absolute",top:"-1000px",left:"-1000px"}));o=v[0];i={aborted:0,responseText:null,responseXML:null,status:0,statusText:"n/a",getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(a){var c=a==="timeout"?"timeout":"aborted";p("aborting upload... "+c);this.aborted=1;try{o.contentWindow.document.execCommand&&o.contentWindow.document.execCommand("Stop")}catch(d){}v.attr("src",
e.iframeSrc);i.error=c;e.error&&e.error.call(e.context,i,c,a);j&&b.event.trigger("ajaxError",[i,e,c]);e.complete&&e.complete.call(e.context,i,c)}};(j=e.global)&&0===b.active++&&b.event.trigger("ajaxStart");j&&b.event.trigger("ajaxSend",[i,e]);if(e.beforeSend&&e.beforeSend.call(e.context,i,e)===!1)return e.global&&b.active--,t.reject(),t;if(i.aborted)return t.reject(),t;if(r=d.clk)if((c=r.name)&&!r.disabled)if(e.extraData=e.extraData||{},e.extraData[c]=r.value,r.type=="image")e.extraData[c+".x"]=d.clk_x,
e.extraData[c+".y"]=d.clk_y;var x=1,w=2;r=b("meta[name=csrf-token]").attr("content");if((c=b("meta[name=csrf-param]").attr("content"))&&r)e.extraData=e.extraData||{},e.extraData[c]=r;e.forceSync?f():setTimeout(f,10);var y,q,z=50,B,D=b.parseXML||function(a,b){window.ActiveXObject?(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a)):b=(new DOMParser).parseFromString(a,"text/xml");return b&&b.documentElement&&b.documentElement.nodeName!="parsererror"?b:null},F=b.parseJSON||function(a){return window.eval("("+
a+")")},E=function(a,c,e){var d=a.getResponseHeader("content-type")||"",f=c==="xml"||!c&&d.indexOf("xml")>=0,a=f?a.responseXML:a.responseText;f&&a.documentElement.nodeName==="parsererror"&&b.error&&b.error("parsererror");e&&e.dataFilter&&(a=e.dataFilter(a,c));typeof a==="string"&&(c==="json"||!c&&d.indexOf("json")>=0?a=F(a):(c==="script"||!c&&d.indexOf("javascript")>=0)&&b.globalEval(a));return a};return t}if(!this.length)return p("ajaxSubmit: skipping submit process - no element selected"),this;
var k,f,m=this;typeof a=="function"&&(a={success:a});k=this.attr("method");f=this.attr("action");(f=(f=typeof f==="string"?b.trim(f):"")||window.location.href||"")&&(f=(f.match(/^([^#]+)/)||[])[1]);a=b.extend(!0,{url:f,success:b.ajaxSettings.success,type:k||"GET",iframeSrc:/^https/i.test(window.location.href||"")?"javascript:false":"about:blank"},a);f={};this.trigger("form-pre-serialize",[this,a,f]);if(f.veto)return p("ajaxSubmit: submit vetoed via form-pre-serialize trigger"),this;if(a.beforeSerialize&&
a.beforeSerialize(this,a)===!1)return p("ajaxSubmit: submit aborted via beforeSerialize callback"),this;var j=a.traditional;if(j===void 0)j=b.ajaxSettings.traditional;var l=[],g,n=this.formToArray(a.semantic,l);if(a.data)a.extraData=a.data,g=b.param(a.data,j);if(a.beforeSubmit&&a.beforeSubmit(n,this,a)===!1)return p("ajaxSubmit: submit aborted via beforeSubmit callback"),this;this.trigger("form-submit-validate",[n,this,a,f]);if(f.veto)return p("ajaxSubmit: submit vetoed via form-submit-validate trigger"),
this;f=b.param(n,j);g&&(f=f?f+"&"+g:g);a.type.toUpperCase()=="GET"?(a.url+=(a.url.indexOf("?")>=0?"&":"?")+f,a.data=null):a.data=f;var u=[];a.resetForm&&u.push(function(){m.resetForm()});a.clearForm&&u.push(function(){m.clearForm(a.includeHidden)});if(!a.dataType&&a.target){var s=a.success||function(){};u.push(function(c){var d=a.replaceTarget?"replaceWith":"html";b(a.target)[d](c).each(s,arguments)})}else a.success&&u.push(a.success);a.success=function(b,c,d){for(var f=a.context||this,g=0,e=u.length;g<
e;g++)u[g].apply(f,[b,c,d||m,m])};g=b('input[type=file]:enabled[value!=""]',this).length>0;f=m.attr("enctype")=="multipart/form-data"||m.attr("encoding")=="multipart/form-data";j=y&&z;p("fileAPI :"+j);var x;a.iframe!==!1&&(a.iframe||(g||f)&&!j)?a.closeKeepAlive?b.get(a.closeKeepAlive,function(){x=c(n)}):x=c(n):x=(g||f)&&j?h(n):b.ajax(a);m.removeData("jqxhr").data("jqxhr",x);for(g=0;g<l.length;g++)l[g]=null;this.trigger("form-submit-notify",[this,a]);return this};b.fn.ajaxForm=function(a){a=a||{};
a.delegation=a.delegation&&b.isFunction(b.fn.on);if(!a.delegation&&this.length===0){var d=this.selector,h=this.context;if(!b.isReady&&d)return p("DOM not ready, queuing ajaxForm"),b(function(){b(d,h).ajaxForm(a)}),this;p("terminating; zero elements found by selector"+(b.isReady?"":" (DOM not ready)"));return this}return a.delegation?(b(document).off("submit.form-plugin",this.selector,s).off("click.form-plugin",this.selector,w).on("submit.form-plugin",this.selector,a,s).on("click.form-plugin",this.selector,
a,w),this):this.ajaxFormUnbind().bind("submit.form-plugin",a,s).bind("click.form-plugin",a,w)};b.fn.ajaxFormUnbind=function(){return this.unbind("submit.form-plugin click.form-plugin")};b.fn.formToArray=function(a,d){var h=[];if(this.length===0)return h;var c=this[0],k=a?c.getElementsByTagName("*"):c.elements;if(!k)return h;var f,m,j,l,g,n;for(f=0,n=k.length;f<n;f++)if(g=k[f],j=g.name)if(a&&c.clk&&g.type=="image")!g.disabled&&c.clk==g&&(h.push({name:j,value:b(g).val(),type:g.type}),h.push({name:j+
".x",value:c.clk_x},{name:j+".y",value:c.clk_y}));else if((l=b.fieldValue(g,!0))&&l.constructor==Array){d&&d.push(g);for(m=0,g=l.length;m<g;m++)h.push({name:j,value:l[m]})}else if(y&&g.type=="file"&&!g.disabled)if(d&&d.push(g),l=g.files,l.length)for(m=0;m<l.length;m++)h.push({name:j,value:l[m],type:g.type});else h.push({name:j,value:"",type:g.type});else l!==null&&typeof l!="undefined"&&(d&&d.push(g),h.push({name:j,value:l,type:g.type,required:g.required}));if(!a&&c.clk&&(k=b(c.clk),f=k[0],(j=f.name)&&
!f.disabled&&f.type=="image"))h.push({name:j,value:k.val()}),h.push({name:j+".x",value:c.clk_x},{name:j+".y",value:c.clk_y});return h};b.fn.formSerialize=function(a){return b.param(this.formToArray(a))};b.fn.fieldSerialize=function(a){var d=[];this.each(function(){var h=this.name;if(h){var c=b.fieldValue(this,a);if(c&&c.constructor==Array)for(var k=0,f=c.length;k<f;k++)d.push({name:h,value:c[k]});else c!==null&&typeof c!="undefined"&&d.push({name:this.name,value:c})}});return b.param(d)};b.fn.fieldValue=
function(a){for(var d=[],h=0,c=this.length;h<c;h++){var k=b.fieldValue(this[h],a);k===null||typeof k=="undefined"||k.constructor==Array&&!k.length||(k.constructor==Array?b.merge(d,k):d.push(k))}return d};b.fieldValue=function(a,d){var h=a.name,c=a.type,k=a.tagName.toLowerCase();d===void 0&&(d=!0);if(d&&(!h||a.disabled||c=="reset"||c=="button"||(c=="checkbox"||c=="radio")&&!a.checked||(c=="submit"||c=="image")&&a.form&&a.form.clk!=a||k=="select"&&a.selectedIndex==-1))return null;if(k=="select"){var f=
a.selectedIndex;if(f<0)return null;for(var h=[],k=a.options,m=(c=c=="select-one")?f+1:k.length,f=c?f:0;f<m;f++){var j=k[f];if(j.selected){var l=j.value;l||(l=j.attributes&&j.attributes.value&&!j.attributes.value.specified?j.text:j.value);if(c)return l;h.push(l)}}return h}return b(a).val()};b.fn.clearForm=function(a){return this.each(function(){b("input,select,textarea",this).clearFields(a)})};b.fn.clearFields=b.fn.clearInputs=function(a){var d=/^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i;
return this.each(function(){var h=this.type,c=this.tagName.toLowerCase();if(d.test(h)||c=="textarea")this.value="";else if(h=="checkbox"||h=="radio")this.checked=!1;else if(c=="select")this.selectedIndex=-1;else if(h=="file")/MSIE/.test(navigator.userAgent)?b(this).replaceWith(b(this).clone()):b(this).val("");else if(a&&(a===!0&&/hidden/.test(h)||typeof a=="string"&&b(this).is(a)))this.value=""})};b.fn.resetForm=function(){return this.each(function(){(typeof this.reset=="function"||typeof this.reset==
"object"&&!this.reset.nodeType)&&this.reset()})};b.fn.enable=function(a){a===void 0&&(a=!0);return this.each(function(){this.disabled=!a})};b.fn.selected=function(a){a===void 0&&(a=!0);return this.each(function(){var d=this.type;if(d=="checkbox"||d=="radio")this.checked=a;else if(this.tagName.toLowerCase()=="option")d=b(this).parent("select"),a&&d[0]&&d[0].type=="select-one"&&d.find("option").selected(!1),this.selected=a})};b.fn.ajaxSubmit.debug=!1})(jQuery);
var AnimalPicture=function(a,b){if(!b)throw"AnimalPicture needs a settings object";this.$obj=a;this.$objInner=a.find(".picture-inner");this.$img=this.$objInner.find(".img-pet");this.$imgOverlay=this.$obj.find(".cloud-overlay");this.$nameSpan=this.$objInner.find(".animal-name");this.cachedStyle=a[0].style;this.$imgOverlay.attr("src","img/cloud-"+b.rotation+".png");this.oldRotation="";this.isVisible=!1;this.init(b,!0);this.waitIntervallID=-1};
AnimalPicture.prototype.init=function(a,b){if(!a)throw"AnimalPicture needs a settings object: "+this.id;this.settings=a;this.id=a.id;this.left=0;this.picLoaded=!1;this.index=0;this.$obj.addClass(a.rotation);this.oldRotation!=a.rotation&&(this.$imgOverlay.attr("src","img/cloud-"+a.rotation+".png"),this.$img.width(a.width),this.$img.height(a.height));this.z=0;this.setName(a.displayName);this.overlayOffset=a.rotation=="landscape"?-41:-65;b&&this.hide();this.oldRotation=a.rotation};
AnimalPicture.prototype.setWaitState=function(a,b){if(HeavenManager.listJSON[a]&&HeavenManager.listJSON[a].data)clearTimeout(this.waitIntervallID),this.init(HeavenManager.listJSON[a].data.pictures[b]),this.loadImage();else{var c=this;this.waitIntervallID=setTimeout(function(){c.setWaitState(a,b)},500)}};AnimalPicture.prototype.setName=function(a){this.$nameSpan.text(a)};
AnimalPicture.prototype.loadImage=function(){var a=this;a.picLoaded||this.settings==null||this.$img.one("load",function(){a.picLoaded=!0;a.isVisible&&$(this).one("webkitTransitionEnd transitionend oTransitionEnd otransitionend",function(){a.$objInner.addClass("no-bg")}).addClass("opacity-transition");a.$objInner.addClass("loaded");$(this).addClass("rot"+(Math.floor(Math.random()*2)+1)+(Math.floor(Math.random()*2)+1==1?"neg":""))}).attr("src",this.settings.imgUrl)};
AnimalPicture.prototype.extractedTranslate3DProperty=function(a){var b={};if(a!==void 0){var c=new CSSMatrix(this.$obj.css("transform"));if(c!==null)for(var d in a)switch(b[a[d]]=0,a[d].toLowerCase()){case "x":b[a[d]]=c.m41;break;case "y":b[a[d]]=c.m42;break;case "z":b[a[d]]=c.m43}}return b};AnimalPicture.prototype.add=function(a){a.append(this.$obj);if(!Modernizr.touch)this.$obj.on("click",{self:this},this.focus)};
AnimalPicture.prototype.focus=function(a){var b=a&&a.data?a.data.self:this,c,d,f,e,a=Math.round(Snoffe.settings.viewPortWidth/2);c=Snoffe.settings.cloudWidth/2;if(HeavenManager.zoomMode)HeavenManager.setZoomMode(!1);else if(Modernizr.csstransforms3d?(d=b.extractedTranslate3DProperty(["x","y"]),c=Number(d.x)+c+b.overlayOffset,d=Number(d.y)):c=parseInt(b.$obj.css("left"))+c+b.overlayOffset,f=a-c+b.overlayOffset,e=216-d-b.$obj.height()/2,Snoffe.debug&&console.log("click",b.z,c,f,d,e),Modernizr.csstransforms3d)c=
(c<a?"+":"-")+"="+Math.abs(f),CloudsManager.resetX=c,TweenMax.to(HeavenManager.pictureContainer,0.5,{css:{x:c},ease:Cubic.easeInOut}),TweenMax.to(HeavenManager.heaven,0.5,{css:{y:(d<110?"+":"-")+"="+Math.abs(e),z:Math.abs(b.z)+50},ease:Cubic.easeInOut}),TweenMax.to(CloudsManager.cloudsContainer,0.5,{css:{x:c,y:(d<110?"+":"-")+"="+Math.min(Math.abs(e),60),z:Math.abs(b.z)+50},ease:Cubic.easeInOut}),HeavenManager.setZoomMode(!0);else{b=c<a?1:-1;HeavenManager.repeatCount=Math.floor(Math.abs(a-c)/Snoffe.settings.cloudWidth);
if(b==1&&HeavenManager.dir==-1||b==-1&&HeavenManager.dir==1)HeavenManager.reversed=!0;HeavenManager.dir=b;HeavenManager.start(!1,0)}};AnimalPicture.prototype.remove=function(){this.hide();this.$obj.off("click",this.focus);this.$obj.remove();this.dispose()};AnimalPicture.prototype.hide=function(){this.wobbleStop();this.cachedStyle.display="none";this.isVisible=!1};AnimalPicture.prototype.show=function(){this.wobbleTween||this.wobble();this.cachedStyle.display="block";this.isVisible=!0};
AnimalPicture.prototype.outsideVisibleArea=function(){var a=this.extractedTranslate3DProperty("x");return a&&(a<-Snoffe.settings.cloudWidth||a>751)};
AnimalPicture.prototype.wobble=function(){if(Modernizr.csstransforms3d&&!this.outsideVisibleArea())if(this.wobbleTween)this.wobbleTween.paused()&&this.wobbleTween.resume();else{var a=Math.random()>0.5?4:-4,b=Math.random()>0.5?3:-3,c=Math.random()>0.5?3:-3;TweenMax.set(this.$objInner,{css:{transformPerspective:500,x:a*-1,y:b*-1}});var d=Math.random()*0.4+1,f=Math.random()*0.4+1.4,e=Math.random()+2.5,a=(new TimelineMax({repeat:-1,yoyo:!0})).add(TweenMax.to(this.$objInner,d,{css:{x:a},ease:Power1.easeInOut})).add(TweenMax.to(this.$objInner,
d,{css:{x:a*-1},ease:Power1.easeInOut})),b=(new TimelineMax({repeat:-1,yoyo:!0})).add(TweenMax.to(this.$objInner,f,{css:{y:b},ease:Power1.easeInOut})).add(TweenMax.to(this.$objInner,f,{css:{y:b*-1},ease:Power1.easeInOut})),c=(new TimelineMax({repeat:-1,yoyo:!0})).add(TweenLite.to(this.$objInner,e,{css:{rotationZ:c},ease:Power1.easeInOut})).add(TweenLite.to(this.$objInner,e,{css:{rotationZ:c*-1},ease:Power1.easeInOut}));this.wobbleTween=(new TimelineMax).insertMultiple([a,b,c],0,"start")}};
AnimalPicture.prototype.wobbleStop=function(){this.wobbleTween&&this.wobbleTween.pause()};AnimalPicture.prototype.unload=function(){clearTimeout(this.waitIntervallID);this.hide();if(this.wobbleTween)this.wobbleTween.kill(),this.wobbleTween=null;this.$obj.removeClass(this.oldRotation);this.$objInner.removeClass("loaded no-bg");this.$img.removeClass().addClass("img-pet").attr("src","");this.picLoaded=!1;this.settings=null};
AnimalPicture.prototype.dispose=function(){this.unload();this.$obj=this.$objInner=this.$img=null};
var MyAnimalsCollection={animals:[],updateCache:!0,init:function(){localStorage.getItem("animals")||MyAnimalsCollection.clearAll()},getAnimals:function(){if(MyAnimalsCollection.updateCache)MyAnimalsCollection.animals=JSON.parse(localStorage.getItem("animals")),MyAnimalsCollection.updateCache=!1;return MyAnimalsCollection.animals},addAnimal:function(a,b){MyAnimalsCollection.getAnimals();MyAnimalsCollection.animals.push({id:a,name:b});localStorage.setItem("animals",JSON.stringify(MyAnimalsCollection.animals));
MyAnimalsCollection.updateCache=!0;return MyAnimalsCollection.animals},clearAll:function(){localStorage.setItem("animals",JSON.stringify([]));MyAnimalsCollection.animals=[]}};
var MyAnimals={initalized:!1,init:function(){var a=MyAnimals;if(!a.initalized)MyAnimalsCollection.init(),a.$animalsBar=Snoffe.App.mainContainer.find(".my-animals-bar"),a.$animalsList=Snoffe.App.mainContainer.find(".my-animals-list"),a.$animalsDDL=Snoffe.App.mainContainer.find(".my-animals-ddl"),a.$ddlLabel=a.$animalsDDL.find("span"),a.$ddlSelect=a.$animalsDDL.find("select"),a.$btnDDL=$("#btn-goto-animal"),a.$ddlSelect.on("change",a.updateDDL),a.$animalsList.on("click",".jsMyAnimalsLink",function(){a.getAnimal($(this).text());
return!1}),a.initalized=!0;a.updateAnimalsList()},hide:function(){this.$animalsBar.addClass("invisible")},getAnimal:function(a){if(SearchController.isSearching)return!1;SearchController.$txtSearch.val(a);SearchController.$btnSearch.removeClass("disabled");SearchController.$btnSearch.click()},updateDDL:function(){var a=MyAnimals,b=a.$ddlSelect.children("option:selected"),d=b.text();a.$ddlLabel.text(d);b.length>0&&b[0].index>0?(a.$btnDDL.removeClass("disabled"),a.$btnDDL.on("click",function(){a.getAnimal(a.$ddlSelect.children("option:selected").text());
return!1})):(a.$btnDDL.addClass("disabled"),a.$btnDDL.off("click"))},updateAnimalsList:function(){var a=MyAnimals,b=MyAnimalsCollection.getAnimals(),d="",e="";if(b.length>0){var e='<option value="">Mina bilder</option>',c;for(c in b)d+='<li><a href="#" class="jsMyAnimalsLink" data-id="'+b[c].id+'">'+b[c].id+"</a></li>\n",e+='<option value="'+b[c].id+'">'+b[c].id+"</option>\n";a.$animalsBar.removeClass("invisible");a.$btnDDL.removeClass("invisible");a.$animalsDDL.removeClass("invisible")}else a.$animalsBar.addClass("invisible"),
a.$btnDDL.addClass("invisible"),a.$animalsDDL.addClass("invisible");a.$animalsList.empty().append(d);a.$ddlSelect.empty().append(e);a.updateDDL()}};
var FormHandler={initalized:!1,init:function(a){if(!this.initalized)this.$form=$(a),this.$fileUpload=this.$form.find("#file-picture"),this.$fileUploadText=this.$form.find(".jsInputFileName"),this.$btnSubmit=this.$form.find(".btn-send"),this.$txtName=this.$form.find(".txt-animal-name"),this.$toHeavenBtn=$("#upload").find(".btn-open-heaven"),this.initalized=!0;this.bindEvents()},bindEvents:function(){var a=FormHandler;a.$fileUpload.on("change",function(){var b=a.getFileName();b.length>0&&b.match(/(\.|\/)(gif|jpe?g|png)$/i)&&
a.$fileUploadText.text(b);a.validate()});a.$txtName.on("focus",function(){a.$txtName.on("keyup",function(){a.validate()})}).on("blur",function(){a.$txtName.off("keyup")});a.$btnSubmit.on("click",a.submit)},unbindEvents:function(){var a=FormHandler;a.$fileUpload.off("change");a.$txtName.off("focus blur");a.$btnSubmit.off("click",a.submit)},reset:function(){var a=FormHandler;if(a.loader)a.loader.remove(),a.loader=null;if(a.successDialog)a.successDialog.remove(),a.successDialog=null;a.$form.removeClass("invisible hidden").siblings(".ingress").removeClass("invisible");
a.$fileUpload.val("");a.$txtName.val("");a.$fileUploadText.text("ingen bild vald");this.$toHeavenBtn.removeClass("disabled");a.validate();a.unbindEvents()},submit:function(a){var b=FormHandler;a&&a.preventDefault();if(b.validate())Snoffe.debug&&console.log("FormHandler.submit"),b.unbindEvents(),b.$toHeavenBtn.addClass("disabled"),b.$form.addClass("invisible"),FormHandler.loader=$(Helper.template(Snoffe.App.templates.loader,{content:"Postar bild..."})),b.$form.before(FormHandler.loader),Snoffe.fakeupload?
setTimeout(function(){FormHandler.submitSuccess({imageId:"test1"})},2E3):b.$form.ajaxSubmit({success:b.submitSuccess,error:b.submitError,url:Snoffe.settings.formPostUrl,dataType:"json"})},submitSuccess:function(a){Snoffe.debug&&console.log("submit sucecess",a);var b=FormHandler;if(b.loader)b.loader.remove(),b.loader=null;b.$form.siblings(".ingress").addClass("invisible");b.$form.addClass("hidden");b.successDialog=$(Helper.template(Snoffe.App.templates.uploadSuccess,{code:a.imageId}));b.$form.before(b.successDialog);
MyAnimalsCollection.addAnimal(a.imageId,b.getAnimalName());b.$toHeavenBtn.removeClass("disabled")},submitError:function(a){var b=FormHandler;Snoffe.debug&&console.log("submit error",a);if(b.loader)b.loader.remove(),b.loader=null;b.$toHeavenBtn.removeClass("disabled");b.$form.removeClass("invisible");Snoffe.App.addOverlay();Snoffe.App.showMsg("Det gick inte att ladda upp din bild. Pr\u00f6va igen om en liten stund!");b.bindEvents()},validate:function(){var a=this.getFileName(),b=this.getAnimalName();
b.length>20&&this.$txtName.val(b.substr(0,20));if(a.length>0&&b.length>0)return this.$btnSubmit.removeClass("disabled"),!0;else this.$btnSubmit.hasClass("disabled")||this.$btnSubmit.addClass("disabled");return!1},getFileName:function(){if(this.$fileUpload){var a=this.$fileUpload.val(),b=a.lastIndexOf("\\");b>-1&&a.length>1&&(a=a.substr(b+1));return a}return""},getAnimalName:function(){return this.$txtName.val()}};
var CloudsManager={tlDefault:null,initalized:!1,tTime:null,reversed:!1,startDir:-1,firstTime:!0,timeScale:20,init:function(){if(!this.initalized)CloudsManager.cloudsContainer=Snoffe.App.mainContainer.find(".cloud-container"),CloudsManager.clouds=Snoffe.App.mainContainer.find(".views .cloud"),CloudsManager.tlDefault=new TimelineMax({paused:!0,repeat:-1,onReverseComplete:CloudsManager.reverseComplete,onReverseCompleteScope:CloudsManager}),CloudsManager.setup(),this.initalized=!0},setup:function(){Snoffe.debug&&
console.log("setup",CloudsManager.tlDefault);CloudsManager.tlDefault.clear();CloudsManager.startDir=HeavenManager.dir;var a,c,b;Modernizr.csstransforms3d?(a={x:HeavenManager.dir*943},c={x:HeavenManager.dir*957},b={x:HeavenManager.dir*1020}):(b=HeavenManager.dir>0?"+":"-",a={left:b+"=943"},c={left:b+"=957"},b={left:b+"=1020"});CloudsManager.tlDefault.insertMultiple([TweenMax.to(CloudsManager.clouds.filter(".cloud1"),17,{css:a,ease:Linear.easeOut,repeat:-1}),TweenMax.to(CloudsManager.clouds.filter(".cloud2"),
34.5,{css:c,ease:Linear.easeOut,repeat:-1}),TweenMax.to(CloudsManager.clouds.filter(".cloud3"),87.5,{css:b,ease:Linear.easeOut,repeat:-1})]);CloudsManager.tlDefault.reversed(!1);CloudsManager.tlDefault.timeScale(CloudsManager.timeScale);Snoffe.debug&&console.log("setup dir:",HeavenManager.dir)},start:function(a){if(this.initalized){!CloudsManager.firstTime&&HeavenManager.dir!=CloudsManager.startDir?CloudsManager.reversed=!0:(CloudsManager.reversed=!1,CloudsManager.tlDefault.reversed(!1));if(CloudsManager.firstTime)CloudsManager.firstTime=
!1,CloudsManager.setup(),a?CloudsManager.tlDefault.timeScale(CloudsManager.timeScale):CloudsManager.tlDefault.timeScale(0);CloudsManager.reversed?CloudsManager.tlDefault.reverse():CloudsManager.tlDefault.resume();a?CloudsManager.tlDefault.timeScale(CloudsManager.timeScale):TweenLite.to(CloudsManager.tlDefault,1,{timeScale:CloudsManager.timeScale,ease:Cubic.easeOut});Snoffe.debug&&console.log("CloudsManager.start",CloudsManager.reversed,CloudsManager.tlDefault.timeScale(),CloudsManager.tlDefault.paused())}},
stop:function(a){CloudsManager.tlDefault&&(a?(CloudsManager.tlDefault.timeScale(0),CloudsManager.tlDefault.pause()):TweenLite.to(CloudsManager.tlDefault,1,{timeScale:0,ease:Cubic.easeOut,onComplete:function(){CloudsManager.tlDefault.pause()}}),Snoffe.debug&&console.log("CloudsManager.stop",a,CloudsManager.reversed))},reverseComplete:function(){Snoffe.debug&&console.log("CloudsManager.reverseComplete");CloudsManager.reversed=!1;CloudsManager.setup();CloudsManager.tlDefault.resume()}};
var SearchController={initalized:!1,searchRegexp:/<%\s*?=\s*?(\w+)\s*?%>/gi,isSearching:!1,init:function(){var a=SearchController;if(!a.initalized)a.$container=Snoffe.App.mainContainer.find(".search-area"),a.$txtSearch=$("#txt-search-animal"),a.$btnSearch=$("#btn-search"),a.bindEvents(),a.initalized=!0,a.$container.removeClass("hidden")},bindEvents:function(){var a=SearchController;a.$txtSearch.on("focus",function(){a.$txtSearch.on("keyup",function(b){a.isSearching||(a.$txtSearch.val().length>0?(a.$btnSearch.removeClass("disabled"),
b.which==13&&a.$btnSearch.click()):a.$btnSearch.addClass("disabled"))})}).on("blur",function(){a.$txtSearch.off("keyup")});a.$btnSearch.on("click",function(b){b.preventDefault();a.$btnSearch.hasClass("disabled")||a.search(a.$txtSearch.val())})},search:function(a){var b=SearchController,d=Helper.template(Snoffe.settings.searchUrl,{content:encodeURIComponent(a)});if(!b.isSearching)Snoffe.App.removeMsg(),b.$btnSearch.addClass("disabled"),Snoffe.App.addOverlay(),Snoffe.App.showLoader(!0),HeavenManager.setWobble(!1),
b.isSearching=!0,setTimeout(function(){b.jqXHR=$.get(d).fail(function(a,c,d){Snoffe.debug&&console.log("search : error",c,d);Snoffe.App.showLoader(!1);c=="abort"?Snoffe.App.removeOverlay():Snoffe.App.showMsg("Det g\u00e5r inte att s\u00f6ka f\u00f6r tillf\u00e4llet. Prova igen om en liten stund!");b.isSearching=!1}).success(function(a){Snoffe.debug&&console.log("success",a);Snoffe.App.showLoader(!1);a&&a.length>0?a[0].publishState.toLowerCase()=="approved"?(HeavenManager.clear(),HeavenManager.currentPage=
1,HeavenManager.totalCount>0?(b.setupResult(a),HeavenManager.createAnimalObjects(),HeavenManager.show(),Snoffe.App.removeOverlay()):HeavenManager.getJSONList(1).success(function(c){if(HeavenManager.totalCount>0){if(HeavenManager.noAnimalsMsg)HeavenManager.noAnimalsMsg.remove(),HeavenManager.noAnimalsMsg=null;HeavenManager.setupScene(c)}b.setupResult(a);HeavenManager.show();Snoffe.App.removeOverlay()})):a[0].publishState.toLowerCase()=="declined"?Snoffe.App.showMsg("Bilden eller namnet du skrev l\u00e4mpar sig inte f\u00f6r Djurhimlen."):
a[0].publishState.toLowerCase()=="pending"?Snoffe.App.showMsg("Ditt djur finns inte p\u00e5 himlen \u00e4n, vi l\u00e4gger ut nya djur vardagar efter kl 15:00."):Snoffe.App.showMsg("Djuret finns inte p\u00e5 himlen."):Snoffe.App.showMsg("Djuret finns inte p\u00e5 himlen.");b.isSearching=!1}).always(function(){b.jqXHR=null;b.$txtSearch.val().length>0&&b.$btnSearch.removeClass("disabled")})},500)},setupResult:function(a){HeavenManager.listJSON[0].data.pictures[4]=a[0];HeavenManager.listJSON[0].data.pictures[4].rotation=
a[0].width>a[0].height?"landscape":"portrait";HeavenManager.listJSON[0].data.pictures[4].index=5},cancelSearch:function(){var a=SearchController;a.jqXHR&&a.jqXHR.abort()}};
var HeavenManager={current:[],currentPage:1,totalPages:1,totalCount:0,dir:-1,listJSON:[],heaven:null,container:null,pictureContainer:null,pagingContainer:null,running:!1,mainTL:null,reversed:!1,lastYPosition:1,zoomMode:!1,initalized:!1,repeatCount:-1,currRepeatCount:0,touchStartX:0,touchStartY:0,touchStartTime:null,touchEndTime:null,init:function(){var a=HeavenManager;a.heaven=$("#heaven");a.pictureContainer=a.heaven.find(".pictures");a.container=a.pictureContainer.find("ul");a.initalized?(MyAnimals.updateAnimalsList(),
a.setWobble(!0)):(Snoffe.App.showLoader(!0),a.getJSONList(a.currentPage).success(function(b){a.totalCount==0?(a.noAnimalsMsg=$(Helper.template(Snoffe.App.templates.msgViewNoClose,{content:"Det finns inga djur p\u00e5 himlen \u00e4n."})),Snoffe.App.mainContainer.append(a.noAnimalsMsg)):a.setupScene(b);MyAnimals.init();SearchController.init();a.initalized=!0;Snoffe.App.showLoader(!1)}))},setupScene:function(){var a=HeavenManager;if(a.totalPages>1)a.getJSONList(a.totalPages);else if(a.totalCount<Snoffe.settings.nrOnScreen){for(var b=
Math.floor(Snoffe.settings.nrOnScreen/a.totalCount),c=HeavenManager.listJSON[HeavenManager.currentPage-1].data.pictures.slice(0),d=0;d<b;++d)for(var e=0;e<c.length;++e)HeavenManager.listJSON[HeavenManager.currentPage-1].data.pictures.push(c[e]);a.totalCount*=b+1}a.createAnimalObjects();a.setupPages()},createAnimalObjects:function(){var a=0,b,c,d=HeavenManager.listJSON[HeavenManager.currentPage-1].data.pictures;Snoffe.debug&&console.log("HeavenManager.createAnimalObjects",d,Snoffe.settings.nrOnScreen);
for(a=0;a<Snoffe.settings.nrOnScreen;a++)c=d[a],b=$(Snoffe.App.templates.picClouds),b=new AnimalPicture(b,c),b.index=a,HeavenManager.current[a]=b,b.add(HeavenManager.container),c=Snoffe.settings.cloudWidth*a+Snoffe.settings.offset-b.overlayOffset-Snoffe.settings.extraWidth/2,Modernizr.csstransforms3d?(b.z=Math.random()*-200,TweenLite.set(b.$obj,{css:{x:c,y:Math.random()*200+10,z:b.z}})):b.$obj.css({left:Math.round(c)+"px",top:Math.round(Math.random()*200)+10+"px"}),b.show(),b.loadImage()},hide:function(){var a=
HeavenManager;TweenLite.to(a.heaven,0,{css:{rotationY:0},ease:Cubic.easeOut});TweenLite.to(CloudsManager.cloudsContainer,0,{css:{rotationY:0},ease:Cubic.easeOut});$("body").off("mouseup touchend touchcancel");if(a.running)a.mainTL.pause(),a.running=!1;CloudsManager.stop()},show:function(){var a=HeavenManager;a.heaven.find(".pictures").removeClass("hidden");a.pagingContainer&&a.pagingContainer.removeClass("hidden")},clear:function(){var a=HeavenManager;if(a.mainTL){if(a.running)a.mainTL.pause(),a.running=
!1;a.mainTL.kill();a.mainTL.clear();a.mainTL=null}HeavenManager.container.empty();for(a=0;a<HeavenManager.current.length;++a)HeavenManager.current[a].dispose();HeavenManager.current=[]},reset:function(){SearchController.cancelSearch();MyAnimals.hide();HeavenManager.setWobble(!1);HeavenManager.hide()},start:function(a,b){var c=HeavenManager;c.running=!0;Snoffe.debug&&console.log("start",c);c.setWobble(!1);c.mainTL&&c.mainTL.totalProgress()!=0?c.reversed?(c.reversed=!1,c.mainTL.reverse()):c.mainTL.resume():
(c.draw(),c.mainTL.resume(),a||c.mainTL.timeScale(0));a?TweenLite.killTweensOf(c.mainTL):(TweenLite.to(c.mainTL,b||0.5,{timeScale:1,ease:Cubic.easeOut}),c.setZoomMode(!1),$("body").on("mouseup touchend touchcancel",function(a){c.stop();a.stopImmediatePropagation()}));CloudsManager.start(a)},stop:function(a){var b=HeavenManager;b.running=!1;Snoffe.debug&&console.log("stop",b);b.mainTL&&(TweenLite.to(b.heaven,1,{css:{rotationY:0},ease:Cubic.easeOut}),TweenLite.to(CloudsManager.cloudsContainer,1,{css:{rotationY:0},
ease:Cubic.easeOut}),$("body").off("mouseup touchend touchcancel"),TweenLite.to(b.mainTL,a||1,{timeScale:0,ease:Cubic.easeOut,onComplete:function(){Snoffe.App.selectedView=="heaven"&&b.setWobble(!0);b.mainTL.pause()}}),CloudsManager.stop())},setWobble:function(a){for(var b=HeavenManager,c=0;c<b.current.length;++c)a?b.current[c].wobble():b.current[c].wobbleStop()},setZoomMode:function(a){if(!a&&HeavenManager.zoomMode==!0){TweenMax.to(HeavenManager.pictureContainer,0.8,{css:{z:0,x:0},ease:Cubic.easeOut});
TweenMax.to(HeavenManager.heaven,0.8,{css:{y:0,z:0},ease:Cubic.easeOut});var b="+=0";CloudsManager.resetX&&CloudsManager.resetX.length>1&&(b=CloudsManager.resetX.substring(0,1)=="+"?"-":"+",b+=CloudsManager.resetX.substring(1));TweenMax.to(CloudsManager.cloudsContainer,0.8,{css:{y:0,z:0,x:b},ease:Cubic.easeOut})}HeavenManager.zoomMode=a},draw:function(a){var b=HeavenManager,c=[];if(!a)a=Snoffe.settings.cloudWidth;b.mainTL?b.mainTL.clear():b.mainTL=new TimelineMax({onComplete:b.complete,onCompleteScope:b,
onReverseComplete:b.completeReverse,onReverseCompleteScope:b});for(var d=0;d<Snoffe.settings.nrOnScreen;d++){var e=b.current[d],f={},f=Modernizr.csstransforms3d?{x:"+="+b.dir*a}:{left:(b.dir>0?"+":"-")+"="+Math.round(a)};c.push(TweenLite.to(e.$obj,Snoffe.settings.speed,{css:f,ease:Linear.easeNone}))}b.mainTL.reversed(!1);b.mainTL.appendMultiple(c)},complete:function(){var a=HeavenManager,b=a.dir==-1?a.current.length-1:0,c=a.current[a.current.length-1].index+1,d=a.current[0].index-1,e=a.currentPage==
1?a.totalPages:a.currentPage-1,f=a.currentPage==a.totalPages?1:a.currentPage+1,g=a.currentPage*Snoffe.settings.nrPerPage,h=e*Snoffe.settings.nrPerPage;c==a.totalCount&&(c=0);d<0&&(d=a.totalCount-1);o=a.dir==-1?a.current.shift():a.current.pop();o.unload();a.addObject(o,a.dir==-1?c:d);a.dir==-1?a.current.push(o):a.current.unshift(o);a.currRepeatCount++;if(a.repeatCount>-1&&a.currRepeatCount>=a.repeatCount)a.repeatCount=-1,a.currRepeatCount=0,a.stop(0);a.draw();if(a.dir==-1){if(a.current[b].index>=g-
30&&!a.listJSON[a.currentPage]&&(console.log("load next"),a.listJSON[a.currentPage]={},a.getJSONList(f)),a.current[b].index>g)a.currentPage=f}else if(a.dir==1&&(a.current[b].index>=h-30&&!a.listJSON[e-1]&&(console.log("load prev"),a.listJSON[e-1]={},a.getJSONList(e)),a.current[b].index<h))a.currentPage=e},completeReverse:function(){HeavenManager.draw()},addObject:function(a,b){var c=HeavenManager,d;d=Math.floor(b/Snoffe.settings.nrPerPage);var e=b-d*Snoffe.settings.nrPerPage;Snoffe.debug&&console.log("addObject",
b,d,e,c.listJSON);c.listJSON[d]&&c.listJSON[d].data?a.init(c.listJSON[d].data.pictures[e]):(a.setWaitState(d,e),a.setName("..."));a.index=b;d=c.dir==-1?Snoffe.settings.cloudWidth*(Snoffe.settings.nrOnScreen-1)+Snoffe.settings.offset-a.overlayOffset-Snoffe.settings.extraWidth/2:Snoffe.settings.offset-a.overlayOffset-Snoffe.settings.extraWidth/2;Modernizr.csstransforms3d?(y=c.lastYPosition==1?Math.random()*60+160:Math.random()*100+10,a.z=Math.random()*-200,TweenLite.set(a.$obj,{css:{x:d,y:y,z:a.z}})):
(y=c.lastYPosition==1?Math.round(Math.random()*60)+160:Math.round(Math.random()*100)+10,a.$obj.css({left:Math.round(d)+"px",top:y+"px"}));a.loadImage();a.show();a.wobbleStop();c.lastYPosition=c.lastYPosition==1?0:1},next:function(a){var b=HeavenManager;if(!b.running||b.running&&b.dir==1)b.reversed=b.dir==1?!0:!1,b.dir=-1,b.start(),Modernizr.csstransforms3d&&(TweenLite.to(CloudsManager.cloudsContainer,1.5,{css:{rotationY:5},ease:Cubic.easeInOut}),TweenLite.to(b.heaven,1.5,{css:{rotationY:10},ease:Cubic.easeInOut}));
a&&(a.preventDefault(),a.stopImmediatePropagation())},prev:function(a){var b=HeavenManager;if(!b.running||b.running&&b.dir==-1)b.reversed=b.dir==-1?!0:!1,b.dir=1,b.start(),Modernizr.csstransforms3d&&(TweenLite.to(CloudsManager.cloudsContainer,1.5,{css:{rotationY:-5},ease:Cubic.easeInOut}),TweenLite.to(b.heaven,1.5,{css:{rotationY:-10},ease:Cubic.easeInOut}));a&&(a.preventDefault(),a.stopImmediatePropagation())},touchStart:function(a){var b=HeavenManager;if(a&&a.originalEvent.touches&&a.originalEvent.touches.length==
1)$("#debug").text("touchStart"),Snoffe.debug&&console.log("HeavenManager.touchStart"),b.touchStartTime=Number(new Date),b.touchStartX=a.originalEvent.touches[0].pageX,b.touchStartY=a.originalEvent.touches[0].pageY,b.mainTL&&(TweenLite.killDelayedCallsTo(b.stop),b.mainTL.pause(),CloudsManager.stop(!0))},touchEnd:function(a){var b=HeavenManager,c,d;$("#debug").text("touchEnd");b.touchEndTime=Number(new Date);d=a.originalEvent.changedTouches[0].pageX;c=b.touchStartX-d;Snoffe.debug&&console.log("HeavenManager.touchEnd",
b.touchStartTime,Math.abs(c),d,b.touchStartX,b.startTouchX-d);if(b.touchEndTime-b.touchStartTime<550&&Math.abs(c)>20){if(b.touchStartX>d){if(b.dir==1)b.reversed=!0;b.dir=-1}else{if(b.dir==-1)b.reversed=!0;b.dir=1}c=Math.min(2.5,Math.abs((d-b.touchStartX)/(b.touchEndTime-b.touchStartTime)));b.mainTL||b.draw();b.mainTL.timeScale(c);TweenLite.killDelayedCallsTo(b.stop);b.start(!0);TweenLite.delayedCall(Math.min(1,c),b.stop,b);a.preventDefault()}},setupPages:function(){var a=HeavenManager;if(a.totalCount>
0&&(this.pagingContainer=$(Snoffe.App.templates.paging).addClass("show"),Snoffe.App.mainContainer.append(this.pagingContainer),Snoffe.App.mainContainer.find(".page-prev").on("click",!1).on("mousedown touchstart",this.prev),Snoffe.App.mainContainer.find(".page-next").on("click",!1).on("mousedown touchstart",this.next),Modernizr.touch))a.pictureContainer.on("touchend",a.touchEnd).on("touchstart",a.touchStart)},getJSONList:function(a){return $.get(Helper.template(Snoffe.settings.listUrl,{count:Snoffe.settings.nrPerPage,
offset:a}),null,null,"json").error(function(a){Snoffe.debug&&console.log("getJSONList : error",a);Snoffe.App.showLoader(!1);Snoffe.App.showMsg("Det gick inte att h\u00e4mta n\u00e5gra bilder f\u00f6r tillf\u00e4llet. Prova igen om en liten stund!")}).success(function(b){Snoffe.debug&&console.log("getJSONList : success",b);if(b&&b.totalImageCount)HeavenManager.totalCount=b.totalImageCount,HeavenManager.totalPages=Math.ceil(HeavenManager.totalCount/Snoffe.settings.nrPerPage);HeavenManager.listJSON[a-
1]={time:new Date,data:b};var b=HeavenManager.listJSON[a-1].data.pictures,c,d;for(d in b)c=b[d],HeavenManager.listJSON[a-1].data.pictures[d].rotation=c.width>c.height?"landscape":"portrait",HeavenManager.listJSON[a-1].data.pictures[d].index=(a-1)*Snoffe.settings.nrPerPage+(d+1)})}};
var Stars={canvas:null,context:null,width:751,height:300,starsArray:[],starSize:1,nrOfStars:300,id:null,d:null,init:function(){var a=Stars;a.canvas=$('<canvas class="bg-stars">');var b=a.canvas.get(0);a.context=b.getContext("2d");b.width=a.width;b.height=a.height;a.id=a.context.createImageData(a.starSize,a.starSize);a.d=a.id.data},generateStars:function(){var a=Stars;a.starsArray=[];for(var b=0;b<a.nrOfStars;++b)a.starsArray[b]={nr:b,x:Math.floor(Math.random()*a.width),y:Math.floor(Math.random()*
a.height),opacity:Math.floor(Math.random()*255)}},renderAll:function(){for(var a=Stars,b,c=0;c<a.starsArray.length;++c)b=a.starsArray[c],a.d[0]=255,a.d[1]=255,a.d[2]=255,a.d[3]=b.opacity,a.context.putImageData(a.id,b.x,b.y)},clear:function(a,b,c,d){Stars.context.clearRect(a,b,c,d)}};
var Snoffe={settings:{templateUrl:"data/templates.json",listUrl:"/picture/approved/<%= offset %>/<%=count%>",nrPerPage:100,searchUrl:"/picture/<%= content %>",formPostUrl:"/picture",views:["start","heaven","upload"],nrOnScreen:10,cloudWidth:230,extraWidth:230,speed:0.15,soundUrl:"sounds/theme.mp3",statistics:{category:"barn",section:"snoffe_doden_och_jag",game:"djurhimlen"}}};
$(function(){Snoffe.debug=window.location.search.substring(1).indexOf("debug=1")>-1;Snoffe.force2d=window.location.search.substring(1).indexOf("force2d=1")>-1;Snoffe.debug&&(console.log("Snoffe App Debug Mode"),console.log("Snoffe settings:",Snoffe.settings),window.location.search.substring(1).indexOf("cleardata=1")>-1&&(console.log("Clearing MyAnimals collection data"),MyAnimalsCollection.clearAll()));if(window.location.search.substring(1).indexOf("fakedata=1")>-1)console.log("Using fakedata"),Snoffe.settings.listUrl=
"data/pics.json",Snoffe.settings.searchUrl="data/picture-approved.json";if(window.location.search.substring(1).indexOf("fakeupload=1")>-1)console.log("Using fakeupload"),Snoffe.fakeupload=!0;if(!Modernizr.highend)Snoffe.force2d=!0;if(Snoffe.force2d)$("html").removeClass("csstransforms3d").addClass("no-csstransforms3d"),Modernizr.csstransforms3d=!1;responsiveIframe().allowResponsiveEmbedding();if($("html").hasClass("lt-ie8")){var a=$('<div class="oldie"> <img src="img/oldie.png" alt="F\u00f6r att kunna se Djurhimlen m\u00e5ste du uppgradera till Internet Explorer 8 eller h\u00f6gre" /></div>');
$("body").append(a)}else Snoffe.App.init()});
Snoffe.App={templates:null,mainContainer:null,selectedView:null,mainSound:null,init:function(){var a=Snoffe.App,b=$(window);a.mainContainer=$("#snoffeContainer");a.views=a.mainContainer.find(".views");Snoffe.settings.canvasWidth=a.mainContainer.width()+Snoffe.settings.extraWidth;Snoffe.settings.offset=Snoffe.settings.canvasWidth/2-Snoffe.settings.cloudWidth*Snoffe.settings.nrOnScreen/2;b.resize(function(){Snoffe.settings.viewPortWidth=a.mainContainer.width()});b.resize();Modernizr.canvas?(Stars.init(),
a.mainContainer.find(".bg").append(Stars.canvas),Stars.generateStars(),Stars.renderAll()):a.mainContainer.find(".bg").append('<img src="img/stars.png" class="bg-stars" alt="" />');this.loadTemplates().success(function(){a.bindBtnEvents();a.showView("start")})},loadSound:function(){window.location.search.substring(1).indexOf("nosound=1")>-1||soundManager.setup({url:"swf/",onready:function(){Snoffe.App.mainSound=soundManager.createSound({id:"mainTheme",url:Snoffe.settings.soundUrl,volume:0,onfinish:function(){Snoffe.debug&&
console.log("soundManager.createSound","onfinish");Snoffe.App.playSound()}});Snoffe.App.volumeBtn=$(Helper.template(Snoffe.App.templates.volume,{}));Snoffe.App.mainContainer.append(Snoffe.App.volumeBtn);Snoffe.App.volumeBtn.on("click",function(){Snoffe.App.volumeBtn.toggleClass("paused");Snoffe.App.pauseSound(!Snoffe.App.mainSound.paused);return!1});setTimeout(function(){Snoffe.App.volumeBtn.removeClass("no-opacity")},30);Snoffe.App.mainSound.play();TweenLite.to(Snoffe.App.mainSound,2,{volume:100,
onUpdate:function(){Snoffe.App.mainSound.setVolume(Snoffe.App.mainSound.volume)},ease:Cubic.easeIn})},ontimeout:function(){Snoffe.debug&&console.log("soundManager.load","error")}})},pauseSound:function(a){Snoffe.App.mainSound&&(a?Snoffe.App.mainSound.pause():Snoffe.App.mainSound.resume())},showView:function(a){if($.inArray(a,Snoffe.settings.views)!=-1){Snoffe.App.removeMsg();a=="heaven"?(Snoffe.App.mainSound||Snoffe.App.loadSound(),HeavenManager.init()):a=="start"?CloudsManager.init():a=="upload"&&
FormHandler.init("#animal-upload");var b="."+a+"-view";Snoffe.App.selectedView=a;Snoffe.App.mainContainer.find(b).addClass("show");Snoffe.App.mainContainer.find(".view:not("+b+")").removeClass("show")}},getViewFromId:function(a){if(a=="heaven")return HeavenManager;else if(a=="upload")return FormHandler;return null},loadTemplates:function(){return $.get(Snoffe.settings.templateUrl).error(function(a){Snoffe.debug&&console.log("loadTemplates : error",a)}).success(function(a){Snoffe.App.templates=a})},
bindBtnEvents:function(){var a=Snoffe.App;Snoffe.App.mainContainer.find(".jsViewBtn").on("click",function(){var b=$(this),e=b.data("to-view"),c=b.data("from-view"),d=b.data("stats"),c=a.getViewFromId(c);d&&SnoffeStats.logStat(Snoffe.settings.statistics,d);if(b.hasClass("disabled"))return!1;a.removeMsg();a.showLoader(!1);a.showView(e);c&&c.reset&&c.reset();return!1})},showMsg:function(a){Snoffe.App.removeMsg();Snoffe.App.msg=$(Helper.template(Snoffe.App.templates.msgView,{content:a}));Snoffe.App.mainContainer.append(Snoffe.App.msg);
Snoffe.App.msg.find(".close-btn").one("click",Snoffe.App.removeMsg);if(Snoffe.App.overlay)Snoffe.App.overlay.one("click",Snoffe.App.removeMsg)},removeMsg:function(){if(!Snoffe.App.msg)return!1;Snoffe.App.msg.remove();Snoffe.App.msg=null;Snoffe.App.overlay&&Snoffe.App.removeOverlay();return!1},showLoader:function(a){if(!a&&Snoffe.App.loader)Snoffe.App.loader.remove();else if(a){if(!Snoffe.App.loader)Snoffe.App.loader=$(Helper.template(Snoffe.App.templates.loader,{content:"Laddar..."}));Snoffe.App.mainContainer.append(Snoffe.App.loader)}},
addOverlay:function(){Snoffe.App.overlay=$(Helper.template(Snoffe.App.templates.overlay,{}));Snoffe.App.mainContainer.append(Snoffe.App.overlay);setTimeout(function(){Snoffe.App.overlay.addClass("show");Snoffe.App.views.addClass("blur");HeavenManager.pagingContainer&&HeavenManager.pagingContainer.addClass("blur")},30)},removeOverlay:function(){if(Snoffe.App.overlay)Modernizr.csstransforms3d?Snoffe.App.overlay.one("webkitTransitionEnd transitionend oTransitionEnd otransitionend",function(){$(this).remove();
if(!Snoffe.App.overlay.hasClass("show"))Snoffe.App.overlay=null}).removeClass("show"):(Snoffe.App.overlay.remove(),Snoffe.App.overlay=null),Snoffe.App.views.removeClass("blur"),HeavenManager.pagingContainer&&HeavenManager.pagingContainer.removeClass("blur"),Snoffe.App.selectedView=="heaven"&&HeavenManager.setWobble(!0)}};
